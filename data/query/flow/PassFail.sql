SELECT PFD.Key AS Details,
 MIN(PFD.RowId.FCSFile.Sample) AS Sample,
 COUNT(PFD.RowId) AS NumberOfAnalyses,
 CASE 
WHEN( MIN(PFD.CD4_Count)<10000)THEN('LO CD4 ')
ELSE('')
END|| CASE 
WHEN( MIN(PFD.CD8_Count)<10000)THEN('LO CD8 ')
ELSE('')
END|| CASE 
WHEN( MIN( CASE 
WHEN(PFD.Stim='SEB' OR PFD.Stim='sebctrl')THEN(PFD.CD4_RESP)
END)<1.2 OR  MIN( CASE 
WHEN(PFD.Stim='SEB' OR PFD.Stim='sebctrl')THEN(PFD.CD8_RESP)
END)<1.2)THEN('LO SEB ')
ELSE('')
END|| CASE 
WHEN( AVG( CASE 
WHEN(PFD.Stim='Neg Cont' OR PFD.Stim='negctrl')THEN(PFD.CD4_RESP)
END)>0.1 OR  AVG( CASE 
WHEN(PFD.Stim='Neg Cont' OR PFD.Stim='negctrl')THEN(PFD.CD8_RESP)
END)>0.1)THEN('HI BKGRND ')
ELSE('')
END AS Verdict,
 MIN(PFD.CD4_Count) AS MIN_CD4,
 MIN(PFD.CD8_Count) AS MIN_CD8,
 MIN( CASE 
WHEN(PFD.Stim='SEB' OR PFD.Stim='sebctrl')THEN(PFD.CD4_RESP)
END) AS SEB_CD4_RESP,
 MIN( CASE 
WHEN(PFD.Stim='SEB' OR PFD.Stim='sebctrl')THEN(PFD.CD8_RESP)
END) AS SEB_CD8_RESP,
 AVG( CASE 
WHEN(PFD.Stim='Neg Cont' OR PFD.Stim='negctrl')THEN(PFD.CD4_RESP)
END) AS BKGRND_CD4_RESP,
 AVG( CASE 
WHEN(PFD.Stim='Neg Cont' OR PFD.Stim='negctrl')THEN(PFD.CD8_RESP)
END) AS BKGRND_CD8_RESP
FROM PassFailDetails AS PFD
GROUP BY PFD.Key
